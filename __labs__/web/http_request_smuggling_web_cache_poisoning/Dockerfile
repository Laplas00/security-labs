
# Stage 1 ‚Äî Backend
FROM python:3.10-slim as backend

WORKDIR /app
COPY . /app
RUN pip install --no-cache-dir -r requirements.txt gunicorn

# Stage 2 ‚Äî Nginx Proxy (Frontend)
FROM nginx:alpine as frontend

COPY nginx.conf /etc/nginx/nginx.conf

# Stage 3 ‚Äî Final image
FROM python:3.10-slim

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º backend —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
COPY --from=backend /app /app
RUN pip install --no-cache-dir -r requirements.txt gunicorn

# –ö–æ–ø–∏—Ä—É–µ–º nginx
RUN apt update && apt install -y nginx
COPY --from=frontend /etc/nginx/nginx.conf /etc/nginx/nginx.conf

# –°—Ç–∞—Ç–∏–∫–∞ –∏ —à–∞–±–ª–æ–Ω—ã
RUN mkdir -p /app/templates
COPY /templates/index.html /app/templates/index.html

# üß† –ó–∞–ø—É—Å–∫: nginx + gunicorn (–º–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è Flask)
CMD service nginx start && gunicorn app:app --bind 0.0.0.0:5000 --workers 1 --threads 2 --timeout 90

EXPOSE 5000

